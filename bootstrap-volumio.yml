
# goal: change host name, create dedicated user and make host accessible through network.
# use user interface for all configuration, at least for now.....




- name: a playbook to bootstrap volumio
  hosts: '{{ host }}'
  remote_user: volumio
  become: true
  vars:
    - orig_hostname: volumio
  tasks:

    - name: Add new deploy user
      include_role:
        name: deploy-user

    - name: edit /etc/hostname
      replace:
        path: /etc/hostname
        regexp: 'volumio'
        replace: '{{new_hostname}}'

    - name: edit hosts file
      replace:
        path: /etc/hosts
        regexp: 'volumio'
        replace: '{{new_hostname}}'

    - name: rename avahi service
      copy:
        content: |
          <?xml version="1.0" standalone="no"?>
          <service-group>
            <name replace-wildcards="yes">{{new_hostname}}</name>
            <service>
              <type>_http._tcp</type>
              <port>80</port>
            </service>
          </service-group>';
        dest: /etc/avahi/services/volumio.service

    - name: reboot
      async: 1
      poll: 0
      ignore_errors: true
      shell: sleep 5 && shutdown -r now

    - name: wait for host
      become: false
      wait_for:
        timeout: 300
        delay: 15
        connect_timeout: 5
        host: "{{new_hostname}}.local"
        port: 22
      delegate_to: localhost
