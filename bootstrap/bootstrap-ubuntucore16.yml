---
# hostname specified on command line
# goal: change host name and make host accessible through network.
# this includes installing tools like avahi to make above possible.



- name: a playbook to bootstrap ubuntu core 16
  hosts: '{{ host }}'
  vars:
    - orig_hostname4: localhost.localdomain
    - orig_hostname6: localhost6.localdomain6
  tasks:

    - name: change hostname
      become: true
      command: hostnamectl set-hostname {{new_hostname}}

    - name: update hosts file
      become: true
      replace:
        path: /writable/system-data/etc/hosts
        regexp: '{{orig_hostname4}}'
        replace: '{{new_hostname}}'
    - become: true
      replace:
        path: /writable/system-data/etc/hosts
        regexp: '{{orig_hostname6}}'
        replace: '{{new_hostname}}'

    - name: install avahi
      command: snap install avahi

    - name: reboot
      async: 1
      poll: 0
      become: true
      ignore_errors: true
      shell: sleep 5 && shutdown -r now

    - name: wait for host
      wait_for:
        timeout: 300
        delay: 15
        connect_timeout: 5
        host: "{{new_hostname}}.local"
        port: 22
      delegate_to: localhost
